name: Auto Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  create-release:
    name: Auto Build
    runs-on: windows-latest
    permissions:
      contents: write  # é—œéµï¼šå¿…é ˆæ·»åŠ æ­¤æ¬Šé™
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      # ä¸éœ€è¦æŒ‡å®š tokenï¼ŒGitHub æœƒè‡ªå‹•æä¾›
      
    - name: Clone YimMenuV2
      run: |
        git clone --recursive https://github.com/YimMenu/YimMenuV2.git

    - name: Patch YimMenuV2
      run: |
        cd YimMenuV2
        Copy-Item ..\*.py .
        Copy-Item ..\*.TTF .
        Copy-Item ..\*.diff .
        git apply patch.diff
        python font.py
        Move-Item MainFont.cpp src/game/frontend/fonts -Force

    - name: Translate YimMenuV2
      run: |
        python update_translation.py
        python translate.py
    
    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64

    - name: Generate CMake project
      run: |
        cd YimMenuV2
        cmake -D CMAKE_BUILD_TYPE=Release -S. -Bbuild -G Ninja
        
    - name: Build 64bit release DLL
      run: |
        cd YimMenuV2
        cmake --build ./build --config Release --target YimMenuV2

    - name: Find DLL file
      id: find_dll
      run: |
        # å°‹æ‰¾ DLL æ–‡ä»¶
        $dllFiles = Get-ChildItem -Path YimMenuV2 -Recurse -Filter "YimMenuV2.dll" -ErrorAction SilentlyContinue
        if ($dllFiles) {
          foreach ($file in $dllFiles) {
            Write-Host "Found DLL: $($file.FullName)"
            # å°‡æ‰¾åˆ°çš„ç¬¬ä¸€å€‹ DLL è¤‡è£½åˆ°å·¥ä½œç›®éŒ„
            Copy-Item $file.FullName "YimMenuV2.dll"
          }
        } else {
          Write-Host "Searching for any DLL files..."
          Get-ChildItem -Path YimMenuV2 -Recurse -Filter "*.dll" | ForEach-Object { Write-Host "Found DLL: $($_.FullName)" }
          exit 1
        }

    - name: Create Release
      uses: softprops/action-gh-release@v1
      # ä¸éœ€è¦æ‰‹å‹•è¨­ç½® envï¼Œaction æœƒè‡ªå‹•ä½¿ç”¨ GITHUB_TOKEN
      with:
        tag_name: latest
        name: "Autobuild $(Get-Date -Format 'yyyy-MM-dd')"
        body: |
          ğŸš€ Automatic Build of YimMenu
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - Workflow: ${{ github.workflow }}
          - Run Number: ${{ github.run_number }}
        draft: false
        prerelease: false
        make_latest: true  # ç¢ºä¿é€™æ˜¯æœ€æ–°ç‰ˆæœ¬
        files: |
          YimMenuV2.dll

    - name: Commit translation updates
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        git status
        $hasChanges = git diff --name-only
        if ($hasChanges) {
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æäº¤è®Šæ›´
          git add translation.json
          git commit -m "Update translations [skip ci]"
          
          # æ¨é€åˆ°ç•¶å‰åˆ†æ”¯
          git push
        } else {
          Write-Host "No changes to commit"
        }
